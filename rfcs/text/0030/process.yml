# Licensed to Elasticsearch B.V. under one or more contributor
# license agreements. See the NOTICE file distributed with
# this work for additional information regarding copyright
# ownership. Elasticsearch B.V. licenses this file to you under
# the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# 	http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
---
- name: process
  reusable:
    top_level: true
    expected:
      - at: process
        as: entry_leader
        short_override: Information about the entry session leader process.
      - at: process
        as: session_leader
        short_override: Information about the session leader process.
      - at: process
        as: group_leader
        short_override: Information about the process group leader process. Undefined if same as process.

  fields:

    - name: ppid
      level: core
      type: long
      description: >
        Parent process id.
      example: 4242

    - name: sid
      level: core
      type: long
      description: >
        Session id.
      example: 4242

    - name: ppid_start
      level: extended
      type: date
      example: "2016-05-23T08:05:34.853Z"
      description: >
        The time this process's parent started.

    - name: pgid_start
      level: extended
      type: date
      example: "2016-05-23T08:05:34.853Z"
      description: >
        The time this process's process group started.

    - name: sid_start
      level: extended
      type: date
      example: "2016-05-23T08:05:34.853Z"
      description: >
        The time this process's session started.

    - name: previous_args
      level: extended
      type: keyword
      short: Array of process arguments the previous fork or exec.
      description: >
        Array of process arguments, starting with the absolute path to the executable.

        May be filtered to protect sensitive information.
      example: "[\"/usr/bin/ssh\", \"-l\", \"user\", \"10.0.0.16\"]"
      normalize:
        - array

    - name: previous_args_count
      level: extended
      type: long
      short: Length of the process.previous_args array.
      description: >
        Length of the process.previous_args array.

        This field can be useful for querying or performing bucket analysis on
        how many arguments were provided to start a process.
        More arguments may be an indication of suspicious activity.
      example: 4

    - name: previous_executable
      level: extended
      type: keyword
      description: >
        Absolute path to the process previous executable.
      example: /usr/bin/ssh
      multi_fields:
        - type: match_only_text
          name: text

    - name: interactive
      level: extended
      type: boolean
      example: true
      short: Whether the process is connected to an interactive shell.
      description: >
        Whether the process is connected to an interactive shell.

        Process interactivity is infered from the processes file descriptors. If the character device for the controlling tty is the same as stdin and stderr for the process, the process is considered interactive.

        Note: A non-interactive process can belong to an interactive session. Backgrounded processes are an example of this.

    - name: fds
      level: extended
      type: nested
      short: An array of the lowest file descriptors for the process.
      description: >
        An array of the lowest file descriptors for the process.

        Typically includes fd0(stdin), fd1(stdout), fd2(stderr), but can include other non character devices such as files, sockets, pipes and FIFOs.

      example: >
        [
          {
            descriptor:0,
            type: 'char_device',
            char_device: {
              major: 8,
              minor: 1
            }
          },
          {
            descriptor:1,
            type:'char_device',
            char_device: {
              major: 8,
              minor: 1
            }
          },
          {
            descriptor:9,
            type:'pipe',
            pipe: {
              inode: '6183207'
            }
          }
        ]

      normalize:
        - array

    - name: env_vars
      level: extended
      type: nested
      short: Array of environment variables.
      description: >
        Array of environment variables.

        May be filtered to protect sensitive information.
      example: "[{ key: 'PATH', value: '/usr/bin;/usr/local/bin;'}, { key: 'USER', value: 'ubuntu' }]"
      normalize:
        - array

    - name: entry_meta.type
      level: extended
      type: keyword
      short: The entry mechanism.
      description: >
        The entry mechanism.

        Values include: init(e.g systemd), sshd, ssm, kubelet, teleport, terminal, console

    - name: entry_meta.source
      level: extended
      type: source
      short: Entry point information for a session.
      description: >
        Entry point information for a session.

        Remote client information such as ip, port and geo location.

    - name: pid_ns_ino
      level: extended
      type: keyword
      short: Pid namespace inode
      example: 256383
      description: >
        This is the inode number of the namespace in the namespace file system (nsfs). Unsigned int inum in include/linux/ns_common.h.
